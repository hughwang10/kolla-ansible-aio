---
- name: afg
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    vm_name: reusebox001
    vm_timezone: Europe/Dublin
    vm_ip_address: 10.44.147.251
    vm_ip_netmask: 255.255.255.0
    vm_ip_gateway: 10.44.147.1
    vm_ip_dns: 193.181.14.10
    vm_ip_domain: ericsson.com

  tasks:
    - name: Create a VM from a template
      vmware_guest:
        hostname: "{{VC_HOST_IP_ADDRESS}}"
        username: "{{VC_USERNAME}}"
        password: "{{VC_PASSWORD}}"
        validate_certs: no
        folder: vm
        name: "{{vm_name}}"
        guest_id: ubuntu64Guest
        state: poweredon
        template: "{{template_name}}"
        datacenter: afglab
        cluster: afglab-cluster1
        disk:
          - type: thin
            size_gb: 100
            datastore: "{{DATASTORE}}}"
        networks:
        - name: OAM-EXT
          ip: "{{vm_ip_address}}"
          netmask: "{{vm_ip_netmask}}"
          gateway: "{{vm_ip_gateway}}"
        - name: OAM
          ip: 192.168.100.4
          netmask: 255.255.255.0
        customization:
          dns_servers: 
            - "{{vm_ip_dns}}"
          domain: "{{vm_ip_domain}}"
          hostname: "{{vm_name}}"
          timezone: "{{vm_timezone}}"
      tags: deploy

    - name: Update repositories cache and install packages
      delegate_to: "{{vm_ip_address}}"
      become: yes
      apt:
        upgrade: dist
      tags: update

    - name: Update repositories cache and install packages
      delegate_to: "{{vm_ip_address}}"
      become: yes
      apt:
        name:
          - vim
          - tree
          - python-pip
          - python3-pip
          - docker.io
          - python-dev 
          - libffi-dev
          - gcc 
          - libssl-dev 
          - python-selinux
        update_cache: yes
      tags: update

    - name: pip install
      delegate_to: "{{vm_ip_address}}"    
      become: yes    
      pip:
        name:
          - ansible
          - kolla-ansible
          - python-openstackclient
          - python-glanceclient
          - python-neutronclient
        executable: pip3  
      tags: update            
